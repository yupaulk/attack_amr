### Libraries for Installation

`{# {r} # install.packages("BiocManager") # BiocManager::install("ALDEx2") # BiocManager::install(c("phyloseq", "microbiome", "ComplexHeatmap"), update = FALSE) # install.packages("microViz",repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos"))) # install.packages("ggraph") # for taxatree_plots() # install.packages("DT") # for tax_fix_interactive() # install.packages("corncob") # for example datasets and beta binomial models # install.packages("patchwork") # install.packages("ggpubr") # install.packages("ggrepel") # install.packages ("cowplot") # install.packages("rnaturalearth") # install.packages("rnaturalearthdata") # install.packages ("ggspatial") # install.packages("maps") # install.packages("microViz")`

```{r}
#install.packages("lmtest")
```

```{r}
#install.packages("tibble")
# install.packages("grDevices")
```

### Add Installed Libraries to Pipeline

```{r}
library(ALDEx2)
library(stringr)
library(phyloseq)
library(ggplot2)
library(vegan)
library(patchwork)
library(knitr)
library(ggpubr)
library(ggrepel)
library(cowplot)
library(microViz)
library(lubridate, warn.conflicts = FALSE)
library (lmtest)
library (tibble)
library (grDevices)
```

### Load Metadata

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
metadata <- read.csv("metadata_updated.csv", row.names=1)
```

### Loading Metaxa2 Results

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
metaxa_genus <- read.delim("metaxa_genus.txt")

# Create OTU table
OTU_metaxa <- metaxa_genus[,-1]
# Match sample ID order with metadata file
match <- match(rownames(metadata), colnames(OTU_metaxa))
OTU_metaxa <- OTU_metaxa[,match]
all(colnames(OTU_metaxa) == rownames(metadata))
# Create tax table
tax_table_metaxa <- data.frame(str_split_fixed(data.frame(metaxa_genus) [,1], ";", 6))
colnames(tax_table_metaxa) <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus")
# Check if samples are in order
identical(rownames(metadata), colnames(OTU_metaxa))
# Combine into phyloseq object
metaxa_PHY <- phyloseq(otu_table(OTU_metaxa, 
    taxa_are_rows=TRUE), tax_table(as.matrix(tax_table_metaxa)), sample_data(metadata))

# Exclude taxa "Unknown", "Unclassified", "Eukaryota", "Mitochondria", "Archaea", "Chloroplast"
metaxa_PHY <- subset_taxa(metaxa_PHY, Domain == "Bacteria")


# Add SSU counts to metadata
metadata$SSU_counts <- sample_sums(metaxa_PHY)

```

### Insert ARG Counts and Relative Abundance (Resfinder)

```{r, warning=FALSE, error=FALSE, message=FALSE}
counts_resfinder <-as.matrix(read.table("ARG_genemat.txt", header= T, check.names = F, row.names = 1))

# Tax_table
clusters_tax_table_resfinder <- read.csv("clusters_tax_table.txt", header=FALSE, sep=";")
colnames(clusters_tax_table_resfinder) <- c("Gene",  "Cluster_name", "Class")
# Reorder columns
col_order <- c("Class", "Cluster_name", "Gene")
clusters_tax_table_resfinder <- clusters_tax_table_resfinder[, col_order]

# Reorder to match metadata
match <- match(rownames(metadata), colnames(counts_resfinder))
counts_resfinder <- counts_resfinder[,match]
all(colnames(counts_resfinder) == rownames(metadata))


# Reorder to match tax_table
match <- match(rownames(counts_resfinder), clusters_tax_table_resfinder$Gene)
clusters_tax_table_resfinder <- clusters_tax_table_resfinder[match,]
all(rownames(counts_resfinder) == clusters_tax_table_resfinder$Gene)

# remove rownames
counts_resfinder_phy <- counts_resfinder
rownames(counts_resfinder_phy) <- c(1:3146) #PKY: Why hard-coded?
rownames(clusters_tax_table_resfinder) <- c(1:3146) #PKY: Why hard-coded?

# Phyloseq
resfinder_PHY_counts <- phyloseq(otu_table(counts_resfinder_phy, taxa_are_rows = TRUE), 
  sample_data(metadata), tax_table(as.matrix(clusters_tax_table_resfinder)))

# Exclude biological / technical replicates
resfinder_PHY_counts_uniq <- subset_samples(resfinder_PHY_counts, replicate == "NO")
resfinder_PHY_counts_uniq <- subset_samples(resfinder_PHY_counts_uniq, sample_material == "water")

# Create phyloseq object with only HWW samples
resfinder_PHY_counts_HWW <- subset_samples(resfinder_PHY_counts_uniq, HWW == "YES")


```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
counts_resfinder <-as.matrix(read.table("ARG_genemat.txt", header= T, check.names = F, row.names = 1))

# Tax_table
clusters_tax_table_resfinder <- read.csv("clusters_tax_table.txt", header=FALSE, sep=";")
colnames(clusters_tax_table_resfinder) <- c("Gene",  "Cluster_name", "Class")
# Reorder columns
col_order <- c("Class", "Cluster_name", "Gene")
clusters_tax_table_resfinder <- clusters_tax_table_resfinder[, col_order]

# Reorder to match metadata
match <- match(rownames(metadata), colnames(counts_resfinder))
counts_resfinder <- counts_resfinder[,match]
all(colnames(counts_resfinder) == rownames(metadata))

# Reorder to match tax_table
match <- match(rownames(counts_resfinder), clusters_tax_table_resfinder$Gene)
clusters_tax_table_resfinder <- clusters_tax_table_resfinder[match,]
all(rownames(counts_resfinder) == clusters_tax_table_resfinder$Gene)

# Divide by ARG gene lengths
resfinder_lengths <- read.delim("resfinder_lengths.txt", header=FALSE, comment.char="#")
all(rownames(clusters_tax_table_resfinder$Gene) == resfinder_lengths$V1)
resfinder_length_norm <- counts_resfinder/resfinder_lengths[, 2]

# Normalization with Metaxa2 SSU counts
resfinder_length_SSU_norm <- t(t(resfinder_length_norm)/metadata$SSU_counts) * 1540
all(rownames(metadata) == colnames(resfinder_length_SSU_norm))
identical((resfinder_length_norm[3, 5]/metadata$SSU_counts[5]) * 1540, resfinder_length_SSU_norm[3, 5])
all(rownames(resfinder_length_norm) == clusters_tax_table_resfinder$Gene)
# Hide rownames
dim(resfinder_length_SSU_norm)
rownames(resfinder_length_SSU_norm) <- c(1:3146) #PKY: Why hard-coded?

dim(clusters_tax_table_resfinder)
rownames(clusters_tax_table_resfinder) <- c(1:3146) #PKY: Why hard-coded?

# Combine to phyloseq object
resfinder_PHY_rel <- phyloseq(otu_table(resfinder_length_SSU_norm, taxa_are_rows = TRUE), 
  sample_data(metadata), tax_table(as.matrix(clusters_tax_table_resfinder)))

# Exclude biological / technical replicates
resfinder_PHY_rel_uniq <- subset_samples(resfinder_PHY_rel, replicate == "NO")
resfinder_PHY_rel_uniq <- subset_samples(resfinder_PHY_rel_uniq, sample_material == "water")

# Create phyloseq object with only HWW samples
resfinder_PHY_rel_HWW <- subset_samples(resfinder_PHY_rel_uniq, HWW == "YES")
```

### Metaphlan Counts and Relative Abundance

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
metaphlan_counts_merged_abundance_table <- read.delim("merged_metaphlan_count_species.txt", header = T)
mp_counts <- metaphlan_counts_merged_abundance_table[ -c(1) ]

# Tax table
## Check if in order
tax_table_metaphlan_counts <- read.csv2("tax_table_count_metaphlan_species.txt", header=F, sep="")
#all(tax_table_metaphlan_counts$V1 == mp_counts$clade_name)

tax_table_metaphlan_counts <- data.frame(str_split_fixed(data.frame(tax_table_metaphlan_counts) [,1], ";", 7))
colnames(tax_table_metaphlan_counts) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")

tax_table_metaphlan_counts <- apply(tax_table_metaphlan_counts, 2, function(y) (gsub(".__", "", y)))
# 
# # remove first column
# mp_counts <- mp_counts[ -c(1) ]

# Reorder
match <- match(rownames(metadata), colnames(mp_counts))
#mp_counts  <- mp_counts[,match]
all(rownames(metadata) == colnames(mp_counts))

# Combine into phyloseq object
metaphlan_PHY_counts <- phyloseq(otu_table(mp_counts, taxa_are_rows=TRUE), sample_data(metadata), tax_table(as.matrix(tax_table_metaphlan_counts), errorIfNULL = TRUE))

# Leave only bacteria
metaphlan_PHY_counts_bact <- subset_taxa(metaphlan_PHY_counts, Kingdom != "Viruses" & Kingdom != "Eukaryota" & Kingdom != "Archaea")

# Prune to species level
metaphlan_PHY_counts_genus <- tax_glom(metaphlan_PHY_counts_bact, taxrank = "Genus")
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
metaphlan_merged_abundance_table <- read.delim("merged_metaphlan_rel_species.txt", header = T)
mp_rel <- metaphlan_merged_abundance_table[ -c(1) ]

# Tax table
## Check if in order
tax_table_metaphlan <- read.csv2("tax_table_metaphlan_rel_species.txt", header=F, sep="")
all(tax_table_metaphlan$V1 == mp_rel$clade_name) #PKY: no clade_name?

tax_table_metaphlan <- data.frame(str_split_fixed(data.frame(tax_table_metaphlan) [,1], ";", 7))
colnames(tax_table_metaphlan) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus")

tax_table_metaphlan <- apply(tax_table_metaphlan, 2, function(y) (gsub(".__", "", y)))

# remove first column
#mp_rel <- mp_rel[ -c(1) ]

# Reorder
match <- match(rownames(metadata), colnames(mp_rel))

all(rownames(metadata) == colnames(mp_rel))

# Combine into phyloseq object
metaphlan_PHY_rel <- phyloseq(otu_table(mp_rel, taxa_are_rows=TRUE), sample_data(metadata), tax_table(as.matrix(tax_table_metaphlan)))

# Leave only bacteria
metaphlan_PHY_rel_bact <- subset_taxa(metaphlan_PHY_rel, Kingdom != "Viruses" & Kingdom != "Eukaryota" & Kingdom != "Archaea")

# Prune to species level
metaphlan_PHY_rel_genus <- tax_glom(metaphlan_PHY_rel_bact, taxrank = "Genus")

metaphlan_PHY_rel_fam <- tax_glom(metaphlan_PHY_rel_bact, taxrank = "Family")

colnames(sample_data(metaphlan_PHY_rel_genus))


```

### MGE Counts

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
counts_MGE <-as.matrix(read.table("MGE_genemat.txt", header= T, check.names = F, row.names = 1))

# Reorder to match metadata
match <- match(rownames(metadata), colnames(counts_MGE))
counts_MGE <- counts_MGE[,match]
all(colnames(counts_MGE) == rownames(metadata))

# Tax table
MGE_tax_table_trim <- read.delim("MGE_tax_table_trim.txt", header=T)
colnames(MGE_tax_table_trim) <- c("Gene", "Element", "Class")

# Reorder tax_table to match
match <- match(rownames(counts_MGE), MGE_tax_table_trim$Gene)
MGE_tax_table_trim <- MGE_tax_table_trim[match,]
all(rownames(counts_MGE) == MGE_tax_table_trim$Gene)

# remove rownames
counts_MGE_phy <- counts_MGE
rownames(counts_MGE_phy) <- c(1:nrow(counts_MGE)+1)

# Combine into phyloseq object
MGE_PHY_counts <- phyloseq(otu_table(counts_MGE_phy, taxa_are_rows=TRUE), 
                       tax_table(as.matrix(MGE_tax_table_trim)), sample_data(metadata))

# Exclude biological / technical replicates
MGE_PHY_counts_uniq <- subset_samples(MGE_PHY_counts, replicate == "NO")
MGE_PHY_counts_uniq <- subset_samples(MGE_PHY_counts_uniq, sample_material == "water")

# Create phyloseq object with only HWW samples
MGE_PHY_counts_HWW <- subset_samples(MGE_PHY_counts_uniq, HWW == "YES")
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
counts_MGE <-as.matrix(read.table("cp_MGE_genemat.txt", header= T, check.names = F, row.names = 1))

# Reorder to match metadata
match <- match(rownames(metadata), colnames(counts_MGE))
counts_MGE <- counts_MGE[,match]
all(colnames(counts_MGE) == rownames(metadata))

# Tax table
MGE_tax_table_trim <- read.delim("MGE_tax_table_trim.txt", header=T)
colnames(MGE_tax_table_trim) <- c("Gene", "Element", "Class")

# Reorder tax_table to match
match <- match(rownames(counts_MGE), MGE_tax_table_trim$Gene)
MGE_tax_table_trim <- MGE_tax_table_trim[match,]
all(rownames(counts_MGE) == MGE_tax_table_trim$Gene)

# Normalization to MGE lengths
MGE_lengths <- read.delim("MGE_lengths.txt", 
                          header=FALSE, comment.char="#", check.names = F)
match <- match(rownames(counts_MGE), MGE_lengths$V1)
MGE_lengths <- MGE_lengths[match,]
all(rownames(MGE_tax_table_trim$Gene) == MGE_lengths$V1)
counts_MGE_length_norm <- counts_MGE/MGE_lengths[, 2]

# Normalization with Metaxa2 SSU counts
counts_MGE_length_SSU_norm <- t(t(counts_MGE_length_norm)/metadata$SSU_counts) * 1540
all(rownames(metadata) == colnames(counts_MGE_length_SSU_norm))
identical((counts_MGE_length_norm[1, 5]/metadata$SSU_counts[5]) * 1540, counts_MGE_length_SSU_norm[1, 5])
all(rownames(counts_MGE_length_norm) == MGE_tax_table_trim$Gene)

# Hide rownames
rownames(counts_MGE_length_SSU_norm) <- c(1:nrow(counts_MGE_length_SSU_norm)+1)

dim(MGE_tax_table_trim)
rownames(MGE_tax_table_trim) <- c(1:nrow(counts_MGE_length_SSU_norm)+1)

# Combine to phyloseq object
MGE_rel_PHY <- phyloseq(otu_table(counts_MGE_length_SSU_norm, taxa_are_rows = TRUE), 
                    sample_data(metadata), tax_table(as.matrix(MGE_tax_table_trim)))
```

### Analysis and Plots

#### Resistomes PCA Plot
```{r}
# Plot HWW
a <- resfinder_PHY_counts_HWW %>% 
  tax_transform("clr") %>% 
  ord_calc(method = "PCA") %>% 
  ord_plot(color = "hospital", size = 4, alpha = 0.8) +
  theme(text = element_text(family = "Palatino"),
    plot.title = element_text(size = 17, hjust = 0.5),
    axis.title = element_text(size = 15, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 17),
    legend.key.size = unit(1, 'cm'),
    legend.position = c(0.15, 0.9),
    legend.background = element_rect(color = "#CECECE"),
    legend.direction = "horizontal",
    axis.text = element_text(size = 15), aspect.ratio = 1) +
  scale_color_manual(values=c("#1C4731", "#910C28", "#1E88E5")) +
  stat_ellipse(level = 0.95, linetype = 2, aes(colour = hospital), size = 0.3)

print(a)
```

```{r}
# Plot all samples
a2 <- resfinder_PHY_counts_uniq %>% 
  tax_transform("clr") %>% 
  ord_calc(method = "PCA") %>% 
  ord_plot(color = "hospital", size = 4, alpha = 0.8) +
  theme(text = element_text(family = "Palatino"),
    plot.title = element_text(size = 17, hjust = 0.5),
    axis.title = element_text(size = 15, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 17),
    legend.key.size = unit(1, 'cm'),
    legend.position = c(0.15, 0.9),
    legend.background = element_rect(color = "#CECECE"),
    legend.direction = "horizontal",
    axis.text = element_text(size = 15), aspect.ratio = 1) +
  scale_color_manual(values=c("#1C4731", "#910C28", "#1E88E5")) +
  stat_ellipse(level = 0.95, linetype = 2, aes(colour = hospital), size = 0.3)

a2_plot <- a2 + geom_label_repel(mapping = aes(label = name), data = subset(a2$data, a2$data$HWW == "NO"),
                          size = 4, box.padding = 0.5, 
                          segment.color = "#CECECE", family = "Palatino")

# Add indication for month with different shapes
a2_plot <- a2_plot + geom_point(aes(shape = factor(month)), size = 5)  
# Define labels for month legend
month_labels <- c("May", "June", "July")

a2_plot <- a2_plot +
  scale_shape_manual(name = "Month", 
                     values = c(5, 6,7),  # Assign shapes to each month
                     labels = month_labels)

a2_plot + plot_annotation(tag_levels = list(c("SLMC")), title = "PCA Plot for three hospitals on Resistomes", subtitle = "ARGs") & 
  theme(plot.title = element_text(size = 25, family = "Palatino", face = "bold"),
        plot.subtitle = element_text(size = 25, family = "Palatino", hjust = 0.5),
    plot.tag = element_text(size = 25))

# Save plots for all samples
ggsave(filename = "plot1.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

#### Permanova Statistics for Resistomes

```{r}
# Test the significance 
resfinder_PHY_counts_uniq_temp <- subset_samples(resfinder_PHY_counts_uniq, (hospital == "SLMC" | hospital == "UST"))
resfinder_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
# Test the significance 
resfinder_PHY_counts_uniq_temp <- subset_samples(resfinder_PHY_counts_uniq, (hospital == "SLMC" | hospital == "CGH"))
resfinder_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
# Test the significance 
resfinder_PHY_counts_uniq_temp <- subset_samples(resfinder_PHY_counts_uniq, (hospital == "CGH" | hospital == "UST"))
resfinder_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

#### Metaphlan Taxa PCA Plot

```{r}
# Plot all samples
b2 <- metaphlan_PHY_counts_genus %>% 
  tax_transform("clr") %>% 
  ord_calc(method = "PCA") %>% 
  ord_plot(color = "hospital", size = 4, alpha = 0.8) +
  theme(text = element_text(family = "Palatino"),
    plot.title = element_text(size = 17, hjust = 0.5),
    axis.title = element_text(size = 15, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 17),
    legend.key.size = unit(1, 'cm'),
    legend.position = c(0.13, 0.95),
    legend.background = element_rect(color = "#CECECE"),
    legend.direction = "horizontal",
    axis.text = element_text(size = 15), aspect.ratio = 1) +
  scale_color_manual(values=c("#1C4731", "#910C28", "#1E88E5")) +
  stat_ellipse(level = 0.95, linetype = 2, aes(colour = hospital), size = 0.3)
# Add indication for month with different shapes
b2_plot <- b2 + geom_point(aes(shape = factor(month)), size = 5)  
# Define labels for month legend
month_labels <- c("May", "June", "July")

b2_plot <- b2_plot +
  scale_shape_manual(name = "Month", 
                     values = c(5, 6,7),  # Assign shapes to each month
                     labels = month_labels)
# 
# b2_plot <- b2 + geom_label_repel(mapping = aes(label = name), data = subset(b2$data, b2$data$HWW == "NO"),
#                           size = 4, box.padding = 0.5, 
#                           segment.color = "#CECECE", family = "Palatino")


b2_plot + plot_annotation(tag_levels = list(c("SLMC")), title = "PCA Plot for three hospitals on Taxonomic Composition", subtitle = "Metaphlan") & 
  theme(plot.title = element_text(size = 25, family = "Palatino", face = "bold"),
        plot.subtitle = element_text(size = 25, family = "Palatino", hjust = 0.5),
    plot.tag = element_text(size = 25))

# Save plots for all samples
ggsave(filename = "plot2.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)

```

#### Permanova Statistics on Taxa

```{r}
# Test significance
metaphlan_PHY_counts_genus_uniq_temp <- subset_samples(metaphlan_PHY_counts_genus, (hospital == "SLMC" | hospital == "UST"))
metaphlan_PHY_counts_genus_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
# Test significance
metaphlan_PHY_counts_genus_uniq_temp <- subset_samples(metaphlan_PHY_counts_genus, (hospital == "SLMC" | hospital == "CGH"))
metaphlan_PHY_counts_genus_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
# Test significance
metaphlan_PHY_counts_genus_uniq_temp <- subset_samples(metaphlan_PHY_counts_genus, (hospital == "CGH" | hospital == "UST"))
metaphlan_PHY_counts_genus_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

#### Mobilomes MGE PCA Plot

```{r}
# Plot HWW
c <- MGE_PHY_counts_HWW %>% 
  tax_transform("clr") %>% 
  ord_calc(method = "PCA") %>% 
  ord_plot(color = "hospital", size = 4, alpha = 0.8) +
  theme(text = element_text(family = "Palatino"),
    plot.title = element_text(size = 17, hjust = 0.5),
    axis.title = element_text(size = 15, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 17),
    legend.key.size = unit(1, 'cm'),
    legend.position = c(0.15, 0.9),
    legend.background = element_rect(color = "#CECECE"),
    legend.direction = "horizontal",
    axis.text = element_text(size = 15), aspect.ratio = 1) +
  scale_color_manual(values=c("#1C4731", "#910C28", "#1E88E5")) +
  stat_ellipse(level = 0.95, linetype = 2, aes(colour = hospital), size = 0.3)
```

```{r}

# Plot all samples
c2 <- MGE_PHY_counts_uniq %>% 
  tax_transform("clr") %>% 
  ord_calc(method = "PCA") %>% 
  ord_plot(color = "hospital", size = 4, alpha = 0.8) +
  theme(text = element_text(family = "Palatino"),
    plot.title = element_text(size = 17, hjust = 0.5),
    axis.title = element_text(size = 15, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 17),
    legend.key.size = unit(1, 'cm'),
    legend.position = c(0.165, 0.125),
    legend.background = element_rect(color = "#CECECE"),
    legend.direction = "horizontal",
    axis.text = element_text(size = 15), aspect.ratio = 1) +
  scale_color_manual(values=c("#1C4731", "#910C28", "#1E88E5")) +
  stat_ellipse(level = 0.95, linetype = 2, aes(colour = hospital), size = 0.3)

# Add indication for month with different shapes
c2<- c2 + geom_point(aes(shape = factor(month)), size = 5)  
# Define labels for month legend
month_labels <- c("May", "June", "July")

c2 <- c2 +
  scale_shape_manual(name = "Month", 
                     values = c(5, 6,7),  # Assign shapes to each month
                     labels = month_labels)

# c2_plot <- c2 + geom_label_repel(mapping = aes(label = name), data = subset(c2$data, c2$data$HWW == "NO"),
#                           size = 4, box.padding = 0.5, 
#                           segment.color = "#CECECE", family = "Palatino")


# Save plots for all samples
c2+ plot_annotation(tag_levels = list(c("UST")), title = "PCA Plot with clr-transformed data on Mobilomes", subtitle = "MGEs") & 
  theme(plot.title = element_text(size = 25, family = "Palatino", face = "bold"),
        plot.subtitle = element_text(size = 25, family = "Palatino", hjust = 0.5),
    plot.tag = element_text(size = 25))

ggsave(filename = "plot4.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

#### Permanova Statistics for MGE

```{r}
MGE_PHY_counts_uniq_temp <- subset_samples(MGE_PHY_counts_uniq, (hospital == "SLMC" | hospital == "UST"))
MGE_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
MGE_PHY_counts_uniq_temp <- subset_samples(MGE_PHY_counts_uniq, (hospital == "SLMC" | hospital == "CGH"))
MGE_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)
```

```{r}
MGE_PHY_counts_uniq_temp <- subset_samples(MGE_PHY_counts_uniq, (hospital == "CGH" | hospital == "UST"))
MGE_PHY_counts_uniq_temp %>%
  dist_calc("aitchison") %>%
  dist_permanova(variables = c("hospital"), n_perms = 9999, seed = 12345)

```

#### PCA Plot for Resistomes, Taxa and Mobilomes

```{r}

patchwork0 <- a2_plot + b2_plot + c2 + 
  plot_annotation(tag_levels = list(c('SLMC', 'CGH', 'UST')), 
  title = "PCA, clr-transformed for Resistomes, Taxonomic Composition and Mobilomes") & 
  theme(legend.position = "bottom",
        plot.title = element_text(size = 30, family = "Palatino", face = "bold"),
        plot.tag = element_text(size = 25, face = "bold"))
patchwork <- patchwork0 + plot_layout(guides = "collect")
#patchwork

# Save plots for HWW samples
ggsave(filename = "plot3.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

### Diversity Metrics

#### ARGs (Exclude)
```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
shannon_div <- data.frame("shannon" = diversity(otu_table(resfinder_PHY_counts_HWW), index = "shannon", MARGIN = 2))
all(rownames(shannon_div) == colnames(resfinder_PHY_counts_HWW@otu_table))
diversity_observed <- apply(resfinder_PHY_counts_HWW@otu_table > 0, 2, sum)
shannon_div$observed <- diversity_observed
shannon_div$hospital <- as.factor(resfinder_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(shannon ~ hospital, data = shannon_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(shannon_div$shannon, shannon_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(shannon_div, aes(x=hospital, y=shannon, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for ARGs Across Hospitals", 
                subtitle = "Shannon Diversity Index by Hospital") +
                scale_y_continuous(limits = c(4,max(shannon_div$shannon)), breaks = seq(4,max(shannon_div$shannon), by = 0.5))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(shannon_div), shannon_div$shannon)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot


# Save plot
ggsave(filename = "plot5_arg_shannon.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
simpson_div <- data.frame("simpson" = diversity(otu_table(resfinder_PHY_counts_HWW), index = "simpson", MARGIN = 2))
all(rownames(simpson_div) == colnames(resfinder_PHY_counts_HWW@otu_table))
diversity_observed <- apply(resfinder_PHY_counts_HWW@otu_table > 0, 2, sum)
simpson_div$observed <- diversity_observed
simpson_div$hospital <- as.factor(resfinder_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(simpson ~ hospital, data = simpson_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(simpson_div$simpson, simpson_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(simpson_div, aes(x=hospital, y=simpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for ARGs Across Hospitals", 
                subtitle = "Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(0.94,max(simpson_div$simpson)), breaks = seq(0.94,max(simpson_div$simpson), by = 0.02))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(simpson_div), simpson_div$simpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot5_arg_simpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
invsimp_div <- data.frame("invsimpson" = diversity(otu_table(resfinder_PHY_counts_HWW), index = "inv", MARGIN = 2))
all(rownames(invsimp_div) == colnames(resfinder_PHY_counts_HWW@otu_table))
diversity_observed <- apply(resfinder_PHY_counts_HWW@otu_table > 0, 2, sum)
invsimp_div$observed <- diversity_observed
invsimp_div$hospital <- as.factor(resfinder_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(invsimpson ~ hospital, data = invsimp_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(invsimp_div$invsimpson, invsimp_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(invsimp_div, aes(x=hospital, y=invsimpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for ARGs Across Hospitals", 
                subtitle = "Inv Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(15,max(invsimp_div$invsimpson)), breaks = seq(15,max(invsimp_div$invsimpson), by = 10))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(invsimp_div), invsimp_div$invsimpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot5_arg_invsimpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
rich <- data.frame("richness" = specnumber(otu_table(resfinder_PHY_counts_HWW), MARGIN=2))
all(rownames(rich) == colnames(resfinder_PHY_counts_HWW@otu_table))
rich$hospital <- as.factor(resfinder_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(richness ~ hospital, data = rich)

# There are sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(rich$richness, rich$hospital,
                 p.adjust.method = "BH")
stat.test

pvalues <- data.frame(group1 = c("SLMC","UST","CGH"), group2 = c("CGH","SLMC","UST"), p.adj = c("**","n.s.","**"))

# Plot
p <- ggboxplot(rich, x = "hospital", y = "richness", fill = "hospital", palette = c("#64B98F", "#CD3857", "#61A6E3")) + 
  stat_pvalue_manual(pvalues, size = 6, y.position = 800, step.increase = 0.05, label = "p.adj")

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4, aes(fill=hospital)) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Richness for ARGs Across Hospitals", 
                subtitle = "Richness by Hospital") +
                scale_y_continuous(limits = c(350,850), breaks = seq(350,850, by = 50))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(rich), rich$richness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot5_arg_richness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
even <- data.frame("evenness" = shannon_div$shannon / log(rich$richness))
rownames(even) <- colnames(resfinder_PHY_counts_HWW@otu_table)
all(rownames(even) == colnames(resfinder_PHY_counts_HWW@otu_table))
even$hospital <- as.factor(resfinder_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(evenness ~ hospital, data = even)

# There are sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(even$evenness, even$hospital,
                 p.adjust.method = "BH")
stat.test

pvalues <- data.frame(group1 = c("SLMC","UST","CGH"), group2 = c("CGH","SLMC","UST"), p.adj = c("n.s.","n.s.","**"))

# Plot
p <- ggboxplot(even, x = "hospital", y = "evenness", fill = "hospital", palette = c("#64B98F", "#CD3857", "#61A6E3")) + 
  stat_pvalue_manual(pvalues, size = 6, y.position = 0.85, step.increase = 0.05, label = "p.adj")

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4, aes(fill=hospital)) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Evenness for ARGs Across Hospitals", 
                subtitle = "Pielou's Evenness by Hospital") +
                scale_y_continuous(limits = c(0.65,0.9), breaks = seq(0.65,0.9, by = 0.05))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(even), even$evenness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot5_arg_evenness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r}
# # Plot
# p <- ggplot(div, aes(x=hospital, y=shannon, fill = hospital)) + 
#   geom_dotplot(binaxis='y', stackdir='center', dotsize = 1) + 
#   scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
#   theme_classic() + 
#   theme(
#     text = element_text(family = "Palatino"),
#     axis.title.y = element_text(size = 35),
#     axis.title.x = element_blank(),
#     axis.text.y = element_text(size = 20),
#     axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
#     legend.position = "none",
#     plot.title = element_text(face = "bold"),
#     plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm")
#   )
# 
# # Add labels
# p <- p + labs(title = "Diversity Metrics for ARGs Across Hospitals", subtitle = "Shannon Diversity Index by Hospital") +
#   annotate("text", x = 3, y = -0.3, label = "ABC", size = 6)
# 
# # Display plot
# print(p)

```

```{r}
# Experiment Plots
# p <- ggplot(div, aes(x = hospital, y = 1, fill = shannon)) +
#   geom_tile() +
#   scale_fill_gradient(low = "#FFEDA0", high = "#800026") +  # Adjust colors as needed
#   theme_classic() + 
#   theme(
#     text = element_text(family = "Palatino"),
#     axis.title.y = element_blank(),
#     axis.title.x = element_blank(),
#     axis.text.y = element_blank(),
#     axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
#     legend.position = "right",
#     plot.title = element_text(face = "bold"),
#     plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm")
#   ) +
#   labs(
#     title = "Diversity Metrics for ARGs Across Hospitals",
#     subtitle = "Shannon Diversity Index by Hospital",
#     fill = "Shannon Index"
#   )
# 
# 
# # Add ID as labels
# p <- p + geom_text(aes(label = rownames(div)), hjust = -0.1, vjust = 0.5, size = 4)
# 
# # Display plot
# print(p)

```

```{r}
# Test the significance
# kruskal.test(observed ~ hospital, data = div)
# # There are sig. differences
# 
# # Test multiple pairwise
# stat.test <- pairwise.wilcox.test(div$shannon, div$hospital,
#                  p.adjust.method = "BH")
# stat.test
```

#### Metaphlan

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
# d <- data.frame("shannon" = diversity(otu_table(metaphlan_PHY_counts_genus), index = "shannon", MARGIN = 2))
# div <- cbind(d, data.frame("invsimpson" = diversity(otu_table(metaphlan_PHY_counts_genus), index = "invsimpson", MARGIN = 2)))
# 
# all(rownames(div) == colnames(metaphlan_PHY_counts_genus@otu_table))
# diversity_observed <- apply(metaphlan_PHY_counts_genus@otu_table > 0, 2, sum)
# div$observed <- diversity_observed
# 
# div$"hospital" <- cbind(metaphlan_PHY_counts_genus@sam_data$hospital)
# 
# colnames(div) <- c("shannon", "invsimpson", "observed", "hospital")
# 
# # Plot
# p <- ggplot(div, aes(x=hospital, y=shannon, fill = hospital)) + 
#   geom_boxplot()
# p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
#   scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
#   theme_classic() + theme(text = element_text(family = "Palatino"),
#     axis.title.y = element_text(size = 35),
#     axis.title.x = element_blank(),
#     axis.text.y = element_text(size = 20),
#     axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
#     plot.title = element_text(face = "bold"),
#     legend.position = "none",
#     plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"))
# 
# layout <- "
# ABC
# "
# p1<-p1 + labs(title = "Diversity Metrics for Taxonomic Composition Across Hospitals", subtitle = "Shannon Diversity Index by Hospital") +
#   annotate("text", x = 3, y = -0.3, label = "ABC", size = 6)
# 
# # Add ID as labels
# p1 <- p1 + geom_text(aes(label = rownames(div)), hjust = -0.1, vjust = 0.5, size = 4)
# # Save plot
# ggsave(filename = "plot6.tiff",
#        width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)

```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
shannon_div <- data.frame("shannon" = diversity(otu_table(metaphlan_PHY_counts_genus), index = "shannon", MARGIN = 2))
all(rownames(shannon_div) == colnames(metaphlan_PHY_counts_genus@otu_table))
diversity_observed <- apply(metaphlan_PHY_counts_genus@otu_table > 0, 2, sum)
shannon_div$observed <- diversity_observed
shannon_div$hospital <- as.factor(metaphlan_PHY_counts_genus@sam_data$hospital)
colnames(shannon_div) <- c("shannon", "observed", "hospital")

# Test the significance
kruskal.test(shannon ~ hospital, data = shannon_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(shannon_div$shannon, shannon_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(shannon_div, aes(x=hospital, y=shannon, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for Taxonomic Composition Across Hospitals", 
                subtitle = "Shannon Diversity Index by Hospital") +
                scale_y_continuous(limits = c(2.5,max(shannon_div$shannon)), breaks = seq(2.5,max(shannon_div$shannon), by = 0.5))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(shannon_div), shannon_div$shannon)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot


# Save plot
ggsave(filename = "plot6_tax_shannon.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
simpson_div <- data.frame("simpson" = diversity(otu_table(metaphlan_PHY_counts_genus), index = "simpson", MARGIN = 2))
all(rownames(simpson_div) == colnames(metaphlan_PHY_counts_genus@otu_table))
diversity_observed <- apply(metaphlan_PHY_counts_genus@otu_table > 0, 2, sum)
simpson_div$observed <- diversity_observed
simpson_div$hospital <- as.factor(metaphlan_PHY_counts_genus@sam_data$hospital)
colnames(simpson_div) <- c("simpson", "observed", "hospital")

# Test the significance
kruskal.test(simpson ~ hospital, data = simpson_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(simpson_div$simpson, simpson_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(simpson_div, aes(x=hospital, y=simpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for Taxonomic Composition Across Hospitals", 
                subtitle = "Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(0.9,max(simpson_div$simpson)), breaks = seq(0.9,max(simpson_div$simpson), by = 0.02))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(simpson_div), simpson_div$simpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot6_tax_simpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
invsimp_div <- data.frame("invsimpson" = diversity(otu_table(metaphlan_PHY_counts_genus), index = "inv", MARGIN = 2))
all(rownames(invsimp_div) == colnames(metaphlan_PHY_counts_genus@otu_table))
diversity_observed <- apply(metaphlan_PHY_counts_genus@otu_table > 0, 2, sum)
invsimp_div$observed <- diversity_observed
invsimp_div$hospital <- as.factor(metaphlan_PHY_counts_genus@sam_data$hospital)
colnames(invsimp_div) <- c("invsimpson", "observed", "hospital")

# Test the significance
kruskal.test(invsimpson ~ hospital, data = invsimp_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(invsimp_div$invsimpson, invsimp_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(invsimp_div, aes(x=hospital, y=invsimpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for Taxonomic Composition Across Hospitals", 
                subtitle = "Inv Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(10,max(invsimp_div$invsimpson)), breaks = seq(10,max(invsimp_div$invsimpson), by = 5))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(invsimp_div), invsimp_div$invsimpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot6_tax_invsimpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
rich <- data.frame("richness" = specnumber(otu_table(metaphlan_PHY_counts_genus), MARGIN=2))
all(rownames(rich) == colnames(metaphlan_PHY_counts_genus@otu_table))
rich$hospital <- as.factor(metaphlan_PHY_counts_genus@sam_data$hospital)
colnames(rich) <- c("richness", "hospital")

# Test the significance
kruskal.test(richness ~ hospital, data = rich)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(rich$richness, rich$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(rich, aes(x=hospital, y=richness, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Richness for Taxonomic Composition Across Hospitals", 
                subtitle = "Richness by Hospital") +
                scale_y_continuous(limits = c(200,max(rich$richness)), breaks = seq(200,max(rich$richness), by = 50))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(rich), rich$richness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot6_tax_richness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
even <- data.frame("evenness" = shannon_div$shannon / log(rich$richness))
rownames(even) <- colnames(metaphlan_PHY_counts_genus@otu_table)
all(rownames(even) == colnames(metaphlan_PHY_counts_genus@otu_table))
even$hospital <- as.factor(metaphlan_PHY_counts_genus@sam_data$hospital)

# Test the significance
kruskal.test(evenness ~ hospital, data = even)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(even$evenness, even$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(even, aes(x=hospital, y=evenness, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Evenness for Taxonomic Composition Across Hospitals", 
                subtitle = "Pielou's Evenness by Hospital") +
                scale_y_continuous(limits = c(0.5,max(even$evenness)), breaks = seq(0.5,max(even$evenness), by = 0.05))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(even), even$evenness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot6_tax_evenness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r}
# # Test the significance
# kruskal.test(observed ~ hospital, data = div)
# # There are no sig. differences
# 
# # Test multiple pairwise
# stat.test <- pairwise.wilcox.test(div$observed, div$hospital,
#                  p.adjust.method = "BH")
# stat.test

```

#### Mobilomes MGE (Exclude)

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
# d <- data.frame("shannon" = diversity(otu_table(MGE_PHY_counts_HWW), index = "shannon", MARGIN = 2))
# div <- cbind(d, data.frame("invsimpson" = diversity(otu_table(MGE_PHY_counts_HWW), index = "invsimpson", MARGIN = 2)))
# 
# all(rownames(div) == colnames(MGE_PHY_counts_HWW@otu_table))
# diversity_observed <- apply(MGE_PHY_counts_HWW@otu_table > 0, 2, sum)
# div$observed <- diversity_observed
# 
# div$"hospital" <- cbind(MGE_PHY_counts_HWW@sam_data$hospital)
# 
# colnames(div) <- c("shannon", "invsimpson", "observed", "hospital")
# 
# # Plot
# p <- ggplot(div, aes(x=hospital, y=shannon, fill = hospital)) + 
#   geom_boxplot()
# p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
#   scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
#   theme_classic() + theme(text = element_text(family = "Palatino"),
#     axis.title.y = element_text(size = 35),
#     axis.title.x = element_blank(),
#     axis.text.y = element_text(size = 20),
#     axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
#     legend.position = "none",
#     plot.title = element_text(face = "bold"),
#     plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"))
# 
# layout <- "
# ABC
# "
# 
# p1 <-p1 + labs(title = "Diversity Metrics for MGEs Across Hospitals", subtitle = "Shannon Diversity Index by Hospital") +
#   annotate("text", x = 3, y = -0.3, label = "ABC", size = 6)
# 
# # Add ID as labels
# p1 <- p1 + geom_text(aes(label = rownames(div)), hjust = -0.1, vjust = 0.5, size = 4)
# # Save plot
# ggsave(filename = "plot7.tiff",
#        width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
shannon_div <- data.frame("shannon" = diversity(otu_table(MGE_PHY_counts_HWW), index = "shannon", MARGIN = 2))
all(rownames(shannon_div) == colnames(MGE_PHY_counts_HWW@otu_table))
diversity_observed <- apply(MGE_PHY_counts_HWW@otu_table > 0, 2, sum)
shannon_div$observed <- diversity_observed
shannon_div$hospital <- as.factor(MGE_PHY_counts_HWW@sam_data$hospital)
colnames(shannon_div) <- c("shannon", "observed", "hospital")

# Plot
p <- ggplot(shannon_div, aes(x=hospital, y=shannon, fill = hospital)) + 
  geom_boxplot()

# Test the significance
kruskal.test(shannon ~ hospital, data = shannon_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(shannon_div$shannon, shannon_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for MGEs Across Hospitals", 
                subtitle = "Shannon Diversity Index by Hospital") +
                scale_y_continuous(limits = c(3.5,max(shannon_div$shannon)), breaks = seq(3.5,max(shannon_div$shannon), by = 0.5))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(shannon_div), shannon_div$shannon)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot


# Save plot
ggsave(filename = "plot7_mge_shannon.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
simpson_div <- data.frame("simpson" = diversity(otu_table(MGE_PHY_counts_HWW), index = "simpson", MARGIN = 2))
all(rownames(simpson_div) == colnames(MGE_PHY_counts_HWW@otu_table))
diversity_observed <- apply(MGE_PHY_counts_HWW@otu_table > 0, 2, sum)
simpson_div$observed <- diversity_observed
simpson_div$hospital <- as.factor(MGE_PHY_counts_HWW@sam_data$hospital)
colnames(simpson_div) <- c("simpson", "observed", "hospital")

# Test the significance
kruskal.test(simpson ~ hospital, data = simpson_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(simpson_div$simpson, simpson_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(simpson_div, aes(x=hospital, y=simpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for MGEs Across Hospitals", 
                subtitle = "Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(0.92,max(simpson_div$simpson)), breaks = seq(0.92,max(simpson_div$simpson), by = 0.02))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(simpson_div), simpson_div$simpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot7_mge_simpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
invsimp_div <- data.frame("invsimpson" = diversity(otu_table(MGE_PHY_counts_HWW), index = "inv", MARGIN = 2))
all(rownames(invsimp_div) == colnames(MGE_PHY_counts_HWW@otu_table))
diversity_observed <- apply(MGE_PHY_counts_HWW@otu_table > 0, 2, sum)
invsimp_div$observed <- diversity_observed
invsimp_div$hospital <- as.factor(MGE_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(invsimpson ~ hospital, data = invsimp_div)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(invsimp_div$invsimpson, invsimp_div$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(invsimp_div, aes(x=hospital, y=invsimpson, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Diversity Metrics for MGEs Across Hospitals", 
                subtitle = "Inv Simpson Diversity Index by Hospital") +
                scale_y_continuous(limits = c(15,max(invsimp_div$invsimpson)), breaks = seq(15,max(invsimp_div$invsimpson), by = 10))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(invsimp_div), invsimp_div$invsimpson)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot7_mge_invsimpson.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
rich <- data.frame("richness" = specnumber(otu_table(MGE_PHY_counts_HWW), MARGIN=2))
all(rownames(rich) == colnames(MGE_PHY_counts_HWW@otu_table))
rich$hospital <- as.factor(MGE_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(richness ~ hospital, data = rich)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(rich$richness, rich$hospital,
                 p.adjust.method = "BH")
stat.test

pvalues <- data.frame(group1 = c("SLMC","UST","CGH"), group2 = c("CGH","SLMC","UST"), p.adj = c("**","*","n.s."))

# Plot
p <- ggboxplot(rich, x = "hospital", y = "richness", fill = "hospital", palette = c("#64B98F", "#CD3857", "#61A6E3")) + 
  stat_pvalue_manual(pvalues, size = 6, y.position = 900, step.increase = 0.05, label = "p.adj")

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4, aes(fill = hospital)) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Richness for MGEs Across Hospitals", 
                subtitle = "Richness by Hospital") +
                scale_y_continuous(limits = c(400,950), breaks = seq(400,950, by = 50))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(rich), rich$richness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot7_mge_richness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
even <- data.frame("evenness" = shannon_div$shannon / log(rich$richness))
rownames(even) <- colnames(MGE_PHY_counts_HWW@otu_table)
all(rownames(even) == colnames(MGE_PHY_counts_HWW@otu_table))
even$hospital <- as.factor(MGE_PHY_counts_HWW@sam_data$hospital)

# Test the significance
kruskal.test(evenness ~ hospital, data = even)

# There are no sig. differences

# Test multiple pairwise
stat.test <- pairwise.wilcox.test(even$evenness, even$hospital,
                 p.adjust.method = "BH")
stat.test

# Plot
p <- ggplot(even, aes(x=hospital, y=evenness, fill = hospital)) + 
  geom_boxplot()

# Add ID as label to the plot
p1 <- p + geom_dotplot(binaxis='y', stackdir='center', dotsize = 0.4) + 
  scale_fill_manual(values=c("#64B98F", "#CD3857", "#61A6E3")) +
  theme_classic() + theme(text = element_text(family = "Palatino"),
                          axis.title.y = element_text(size = 35),
                          axis.title.x = element_blank(),
                          axis.text.y = element_text(size = 20),
                          axis.text.x = element_text(size = 16, angle = 30, hjust = 1, face = "bold"),
                          legend.position = "none",
                          plot.title = element_text(face = "bold"),
                          plot.margin = margin(0.25, 0.25, 0.25, 0.25, "cm"))

# Adjust the scale to be more detailed
p1 <- p1 + labs(title = "Evenness for MGEs Across Hospitals", 
                subtitle = "Pielou's Evenness by Hospital") +
                scale_y_continuous(limits = c(0.65,max(even$evenness)), breaks = seq(0.65,max(even$evenness), by = 0.05))

# Add ID as labels
p1 <- p1 + geom_text(aes(label = paste(rownames(even), even$evenness)), hjust = -0.1, vjust = 0.5, size = 4)

p1  # Display the plot

# Save plot
ggsave(filename = "plot7_mge_evenness.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r}
# # Test the significance
# kruskal.test(observed ~ hospital, data = div)
# # There are sig. differences
# 
# # Test multiple pairwise
# stat.test <- pairwise.wilcox.test(div$observed, div$hospital,
#                  p.adjust.method = "BH")
# stat.test
```

### Relative abundances of functional genes

### Relative abundances, ARGs
```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
# Gather data
df<-data.frame(RA=sample_sums(resfinder_PHY_rel_HWW),
               hospital=as.factor(sample_data(resfinder_PHY_rel_HWW)$hospital))
M <-lm(RA~hospital, data=df)
summary(M)
shapiro.test(df$RA)
# Data is not normally distributed.
plot(M)

# Heterosedasticity?
par(mfrow=c(2,2))
#plot(M)

lmtest::bptest(M)  # Breusch-Pagan test
car::ncvTest(M)  # Breusch-Pagan test
# There is no heteroscedasticity.
```

```{r}
# Test
kruskal.test(RA ~ hospital, data = df)
```

```{r}
# Test multiple pairwise
stat.test <- pairwise.wilcox.test(df$RA, df$hospital,
                 p.adjust.method = "BH")
stat.test

pvalues <- tibble::tribble(
  ~group1, ~group2,   ~p.adj,
    "SLMC",     "CGH", "***",
    "SLMC",     "UST", "**",
    "CGH",     "UST", "**"
  )
pvalues

# +
#   stat_pvalue_manual(pvalues, hide.ns = TRUE, size = 8, y.position = 2.5, step.increase = 0.025, label = "p.adj")

# Save plot
p <- ggboxplot(df, x = "hospital", y = "RA", color = "hospital", palette = c("#1C4731", "#910C28", "#1E88E5"), width = 0.3)  +
  theme_bw() +
  theme(axis.text.x = element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 16),
        axis.title.y = element_text(size = 20),
        legend.position = "none",
        plot.subtitle = element_text(size = 24, hjust = 0.5),
        plot.tag = element_text(size = 24, family = "Palatino", face = "bold"),
        text = element_text(family = "Palatino"),
        aspect.ratio = 1) +
  labs(y = "ARGs/16S rRNA", x = "") +
  guides(color = "none", alpha = "none") +
  geom_jitter(data = df, aes(x = hospital, y = RA, color = hospital), size = 3, alpha = 0.7, width = 0.1) +
  geom_text(data = df, aes(x = hospital, y = RA, label = rownames(shannon_div)), size = 3, vjust = -0.5)  +
  labs(title = "Comparison of ARGs/16S rRNA Levels Across Hospitals using Wilcoxx")  # Add title



ggsave(filename = "wilcox.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

## Relative abundance of taxa (metaphlan)

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
cols <- get_palette(c("#332288", "#117733", "#52BFAD", "#88CCEE", "#DDCC77", "#FDA4B3", 
                      "#F22D3D", "#882255", "#5F5E98", "#E4C960", "#FD8FD9"), 41)


metaphlan_PHY_rel_genus <- subset_taxa(metaphlan_PHY_rel_genus, Genus != "Coprobacillaceae Family")
metaphlan_PHY_rel_genus <- subset_taxa(metaphlan_PHY_rel_genus, Genus != "Catenibacterium")
metaphlan_PHY_rel_genus <- subset_taxa(metaphlan_PHY_rel_genus, Genus != "NA")



metaphlan_PHY_rel_genus%>%
 tax_fix(
  min_length = 4,
  unknowns = c("NA"),
  sep = " ", anon_unique = TRUE,
  suffix_rank = "classified"
 )
 
 
# p <- metaphlan_PHY_rel_genus %>%
#   comp_barplot("Genus", facet_by = "hospital", n_taxa = 40) +
#   coord_flip()


p <- metaphlan_PHY_rel_genus %>%
  comp_barplot(tax_level = "Genus", n_taxa = 40,
              tax_transform_for_plot = "identity", facet_by  = "hospital", )+
  coord_flip()  +
  labs(x = NULL, y = NULL) + theme_light() + ggtitle("Top 40 taxa (metaphlan)") +
  theme(text = element_text(family = "Palatino"),
        plot.title = element_text(size = 30, face = "bold"),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20, color = "black", face = "bold", angle = 0, hjust = 0),
        strip.background = element_rect(fill = "white", color = "white"),
        panel.spacing.y = unit(1, "lines"),
        legend.text = element_text(size = 18, face = "italic"),
        legend.title = element_blank(),
        legend.position = "bottom", legend.direction = "horizontal",
        legend.spacing = unit(0.25, 'cm'),
        legend.key.size = unit(0.85, "cm")) + guides(fill = guide_legend(byrow = TRUE))


print (p)

# Save plot
ggsave(filename = "plot12old.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}

# metaphlan_PHY_rel_fam <- subset_taxa(metaphlan_PHY_rel_fam, Family != "Coprobacillaceae")
metaphlan_PHY_rel_genus <- subset_taxa(metaphlan_PHY_rel_genus, Genus != "Catenibacterium")
metaphlan_PHY_rel_genus <- subset_taxa(metaphlan_PHY_rel_genus, Genus != "NA")



metaphlan_PHY_rel_genus%>%
 tax_fix(
  min_length = 4,
  unknowns = c("NA"),
  sep = " ", anon_unique = TRUE,
  suffix_rank = "classified"
 )
 
 
p <- metaphlan_PHY_rel_genus %>%
  comp_barplot("Genus", facet_by = "hospital", n_taxa = 40) +
  coord_flip()


# p <- metaphlan_PHY_rel_fam %>%
#   comp_barplot(tax_level = "Family", n_taxa = 40,
#               tax_transform_for_plot = "identity", facet_by  = "hospital", )+
#   coord_flip()  +
#   labs(x = NULL, y = NULL) + theme_light() + ggtitle("Top 40 taxa (metaphlan)") +
#   theme(text = element_text(family = "Palatino"),
#         plot.title = element_text(size = 30, face = "bold"),
#         axis.text.y = element_text(size = 10),
#         axis.text.x = element_text(size = 20),
#         strip.text.y = element_text(size = 20, color = "black", face = "bold", angle = 0, hjust = 0),
#         strip.background = element_rect(fill = "white", color = "white"),
#         panel.spacing.y = unit(1, "lines"),
#         legend.text = element_text(size = 18, face = "italic"),
#         legend.title = element_blank(),
#         legend.position = "bottom", legend.direction = "horizontal",
#         legend.spacing = unit(0.25, 'cm'),
#         legend.key.size = unit(0.85, "cm")) + guides(fill = guide_legend(byrow = TRUE))


print (p)

# Save plot
ggsave(filename = "plot12oldfam.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
p<-plot_bar(resfinder_PHY_rel_HWW, fill = "Class", x = "hospital")

ggsave(filename = "bar_Resfinder.tiff",
       width = 16, height = 13, dpi = 300, units = "in", device='tiff', scale = 1)
```

```{r}
otu_table_data <- otu_table(resfinder_PHY_rel_HWW)
print(head(otu_table_data))
```
